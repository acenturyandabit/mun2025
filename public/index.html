<html>

<head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto@1&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Model UN 2021</title>
    <link rel="icon" href="logo2.png">
</head>

<body>
    <script src="makeflag.js"></script>
    <style>
        body {
            background-color: darkblue;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body,
        html {
            padding: 0;
            margin: 0;
        }

        * {
            font-family: Roboto, sans-serif;
            text-align: center;
        }

        [data-screen] {
            width: 50vw;
        }

        @media screen and (max-aspect-ratio: 9/10) {
            [data-screen] {
                width: 100vw;
            }
        }

        img,
        canvas {
            width: 40%;
            padding: 30px 0;
        }
    </style>
    <div data-screen="landing">
        <style>
            [data-screen="landing"] {
                align-items: center;
                display: flex;
                flex-direction: column;
            }



            [data-screen="landing"] {
                display: block;
                margin: 10px;
            }

            @keyframes red-flashy {
                from {
                    color: red
                }

                50% {
                    color: white
                }

                to {
                    color: red
                }
            }

            [data-screen="landing"] h2.red_flashy {
                animation: red-flashy 0.2s linear;
            }

            [data-screen="landing"] input,
            [data-screen="landing"] button {
                width: 100%;
                margin: 10px;
                padding: 10px;
                font-size: 1.5em;
            }

            [data-screen="landing"] input::placeholder {
                text-align: center;
            }
        </style>
        <h1>Model UN 2021</h1>
        <h2>A game about diplomacy, for 3-5 players</h2>
        <img src="logo2.png"></img>
        <input id="gid" placeholder="Game ID"></input>
        <button onclick="tryEnterGame()">Join Game</button>
        <h2 id="invalid_gid" style="display:none">Invalid game ID :(</h2>
        <button onclick="tryHostGame()">Host Game</button>
        <!--<a href="acenturyandabit.github.io/mun2200">About</a>-->

        <!-- first enter; choose to join or host a game -->
    </div>
    <div data-screen="waitingRoom">
        <style>
            [data-screen="waitingRoom"] {
                align-items: center;
                display: flex;
                flex-direction: column;
            }

            .player-list {
                position: relative;
                width: 100%;
            }

            .player-list button {
                position: absolute;
                right: 0;
            }
        </style>
        <h2>Game ID: <span id="gid_rep"></span></h2>
        <div class="nation-name">
            <p>You are the diplomat for</p>
            <h2 class="nation_name"></h2>
        </div>
        <button class="wstart" onclick="hostStart()">Waiting for start...</button>
        <div class="country-lore"></div>
        <div class="player-list">
            <h3 class="player-head">Other players:</h3>
        </div>
    </div>
    <div data-screen="main">
        <style>
            [data-screen="main"] {
                align-items: center;
                display: flex;
                flex-direction: column;
            }

            [data-pane="action"] {
                align-items: center;
                display: flex;
                flex-direction: column;
            }

            .inter-round-modal {
                position: absolute;
                flex-direction: column;
                display: flex;
                align-items: center;
                justify-content: center;
                top: 0;
                left: 0;
                background: rgba(0, 0, 0, 0.7);
                width: 100%;
                height: 100%;
            }
        </style>
        <p>Ambassador for <span class="nation-name-p"></span></p>
        <p>Round <span class="current-round"></span> | <span class="current-mode"></span> </p>
        <h3>Objective: <span class="instruction"></span> </h3>
        <div data-pane="action">
            <div class="arrange-order">
                <style>
                    .arrange-order {
                        display: flex;
                    }

                    .arrange-order>div:first-of-type {
                        padding-left: 10px;
                    }

                    .bill_square p:not(.bill-score) {
                        user-select: none;
                        margin: 3px;
                        padding: 10px;
                        border-radius: 10px;
                        background: blue;
                    }

                    body {
                        position: relative;
                    }

                    /*.bill_square p:hover {
                        background: lightblue;
                        color: blue;
                    }*/

                    .gu-mirror {
                        position: absolute;
                        user-select: none;
                        display: none
                    }

                    .bill_square {
                        border: 1px solid white;
                        border-radius: 10px;
                        padding: 10px;
                    }

                    .bill_square p {
                        display: flex;
                        align-items: center;
                        width: calc(100% - 20px);
                    }

                    .bill_square p span:first-child {
                        flex: 0 0 1em;
                        margin-right: 10px;
                        background: white;
                        color: blue;
                    }

                    .bill_square p span {
                        flex: 1 1 auto;
                    }

                    .outer-proto-container {
                        position: relative;
                    }

                    .emplace-above {
                        border-top: 5px solid blueviolet;
                    }
                </style>
                <div class="outer-proto-container">
                    <div class="proto-resolution-dragdrop bill_square">
                        <p>Resolution A</p>
                        <p>Resolution B</p>
                        <p>Resolution C</p>
                        <p>Resolution F</p>
                        <p>Resolution D</p>
                        <p>Resolution E</p>
                    </div>
                </div>
            </div>
            <p class="proto-resolution-score-container">Your score from this ordering:<span
                    class="proto-resolution-score"></span></p>
            <p>Drag blue proposals up and down to reorder, to maximise your score.</p>
            <p>When ready, press "Submit ranking" below to submit your bill for others to approve.</p>
            <button class="submitbill" onclick="submitForApproval()">Submit ranking</button>
        </div>
        <div data-pane="history">
            <style>
                [data-pane="history"] {
                    flex-direction: column;
                }

                .history-list {
                    flex: 1 0 50vh;
                    overflow-y: auto;
                }

                .bill-score {
                    text-align: center;
                }

                .proposalRow {
                    border: 1px solid white;
                    border-radius: 10px;
                    padding: 3px 0px;
                    margin: 3px 0px;
                }

                .proposalBin span {
                    background: white;
                    color: blue;
                    border-radius: 3px;
                    padding: 3px;
                    margin: 1px;
                }

                button.accepted_this {
                    background: green;
                    color: white;
                }
            </style>
            <div class="history-list">
            </div>
            <p>Scroll down to view others' proposed bills from this round.</p>
            <p>You can only approve the latest bill - click "Propose bill" to propose a new bill.</p>
        </div>
        <div class="navigation">
            <style>
                .navigation>p:first-of-type {
                    display: flex;
                    flex-direction: row;
                }

                .navigation button {
                    flex: 1 1 300px;
                }

                .navigation {
                    width: 100%;
                }

                .remaining-time {
                    width: 100%;
                    mix-blend-mode: exclusion;
                }

                .remaining-time-bar {
                    height: 100%;
                    position: absolute;
                    left: 0;
                    background: white;
                }
            </style>
            <p>
                <button style="display:none" data-switch-pane="action">Propse bill</button>
                <button data-switch-pane="history">View proposals</button>
            </p>
            <p style="position: relative;"><span class="remaining-time-bar"></span><span class="remaining-time"></span>
            </p>
        </div>
        <div class="inter-round-modal">
            <h3>Result:</h3>
            <p class="roundresult">Bill passed / rejected</p>
            <div class="accepted-bill-container">

            </div>
            <p>Your current score: <span class="playerscore"></span></p>
            <p>Next round begins in <span class="inter-round-countdown"></span></p>
        </div>
    </div>
    <div data-screen="podium">
        <style>
            .podium {
                display: flex;
                flex-direction: column;
            }
        </style>
        <div class="podium">

        </div>
        <!--Show all players-->
        <!--Start if admin-->
        <!--premise and settings-->
    </div>
    <script>
        let reveal_timers = [];
        function reset_reveals() {
            reveal_timers.forEach(i => clearTimeout(i));
            reveal_timers = [];
        }


        let room = {};
        let dragManagedItem;
        let handleDragStart = (e) => {
            let directChildren = Array.from(document.querySelector(".proto-resolution-dragdrop").children);
            for (let i of e.composedPath()) {
                if (directChildren.includes(i)) {
                    dragManagedItem = i;
                    break;
                }
            }
            if (!dragManagedItem) return;
            dragManagedItem.style.position = "absolute";
            let yy = e.clientY;
            if (!yy) yy = e.touches[0].clientY;
            dragManagedItem.style.top = (yy - dragManagedItem.parentElement.getClientRects()[0].y - 20) + "px";
        }

        let handleDragMove = (e) => {
            if (dragManagedItem) {
                let hoverOverItem;
                let directChildren = Array.from(document.querySelector(".proto-resolution-dragdrop").children);
                directChildren.forEach(i => i.classList.remove("emplace-above"));
                if (e.touches) {
                    let yy = e.changedTouches[0].clientY;
                    for (let i of directChildren) {
                        let clr = i.getClientRects()[0];
                        if (clr.y < yy && clr.y + clr.height > yy) {
                            hoverOverItem = i;
                            break;
                        }
                    }
                } else {
                    for (let i of e.composedPath()) {
                        if (directChildren.includes(i) && i != dragManagedItem) {
                            hoverOverItem = i;
                            break;
                        }
                    }
                }
                if (hoverOverItem) hoverOverItem.classList.add("emplace-above");
                let yy = e.clientY;
                if (!yy) yy = e.touches[0].clientY;
                dragManagedItem.style.top = (yy - dragManagedItem.parentElement.getClientRects()[0].y) + "px";
            }
        }
        let handleDragEnd = (e) => {
            if (dragManagedItem) {
                let hoverOverItem;
                let directChildren = Array.from(document.querySelector(".proto-resolution-dragdrop").children);
                directChildren.forEach(i => i.classList.remove("emplace-above"));
                if (e.touches) {
                    let yy = e.changedTouches[0].clientY;
                    for (let i of directChildren) {
                        let clr = i.getClientRects()[0];
                        if (clr.y < yy && clr.y + clr.height > yy) {
                            hoverOverItem = i;
                            break;
                        }
                    }
                } else {
                    for (let i of e.composedPath()) {
                        if (directChildren.includes(i) && i != dragManagedItem) {
                            hoverOverItem = i;
                            break;
                        }
                    }
                }
                if (hoverOverItem) {
                    //put it back where it belongs
                    hoverOverItem.parentElement.insertBefore(dragManagedItem, hoverOverItem);
                }
                dragManagedItem.style.position = "static";
                dragManagedItem = undefined;
                room.present_order = Array.from(document.querySelectorAll(".proto-resolution-dragdrop p")).map(i => i.innerText[0].charCodeAt(0) - "A".charCodeAt(0));
                if (room.current_set == room.own_set) {
                    let protoScore = room.present_order.reduce((p, i, ii) => p + (room.private_resolutions.indexOf(i) >= ii && room.private_resolutions.indexOf(i) < 4), 0);
                    renderTo(".proto-resolution-score", protoScore);
                }
            }
        }
        [[handleDragStart, "touchstart", "mousedown"],
        [handleDragMove, "touchmove", "mousemove"],
        [handleDragEnd, "touchend", "mouseup"],
        ].forEach(i => {
            i.slice(1).forEach((en) => {
                window.addEventListener(en, i[0]);
            })
        });
        document.querySelector("#gid").addEventListener("keydown", (e) => {
            if (e.key == "Enter") tryEnterGame();
        })
        function switchPanel(panes, pane, display) {
            Array.from(document.querySelectorAll(`[data-${panes}]`)).forEach(i => i.style.display = "none");
            Array.from(document.querySelectorAll(`[data-${panes}="${pane}"]`)).forEach(i => i.style.display = display || "flex");
        }
        switchPanel("screen", "landing");
        function renderTo(selector, value) {
            document.querySelector(selector).innerHTML = value;
        }

        function switchPane(pane) {
            Array.from(document.querySelectorAll(`[data-switch-pane]`)).forEach(i => i.style.display = "block");
            document.querySelector(`[data-switch-pane="${pane}"]`).style.display = "none";
            switchPanel("pane", pane);
        }
        document.querySelector(".navigation").addEventListener("click", (e) => {
            if (e.target.matches(`[data-switch-pane]`)) switchPane(e.target.dataset.switchPane);
        })
        let ws;
        function tryEnterGame() {
            if (!document.querySelector("#gid").value) {
                document.querySelector("#invalid_gid").innerText = "Please enter room ID";
                document.querySelector("#invalid_gid").style.display = "block";
                document.querySelector("#invalid_gid").classList.remove("red_flashy");
                setTimeout(() => {
                    document.querySelector("#invalid_gid").classList.add("red_flashy");
                }, 100);
                return;
            }
            try {
                if (ws) ws.close();
                ws = new WebSocket("ws://" + window.location.hostname + ":3320");
                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        action: "enter_game",
                        room_id: document.querySelector("#gid").value
                    }));
                }
                ws.addEventListener("message", (data) => {
                    data = JSON.parse(data.data);
                    switch (data.state) {
                        case "waiting_room":
                            //take them to the waiting room
                            document.querySelector(".wstart").disabled = true;
                            Array.from(document.querySelectorAll(".player-list div")).forEach(i => i.remove());
                            for (let i of data.players) {
                                let d = document.createElement("div");
                                d.innerText = i;
                                document.querySelector(".player-list").appendChild(d);
                            }
                            renderTo("#gid_rep", data.uid);
                            renderTo(".nation-name", `
                            <p>You are the diplomat for</p>
                            <h2>${data.player_alias}</h2>
                            <canvas></canvas>
                            `);
                            let c = document.querySelector(".nation-name canvas");
                            makeFlag(data.player_alias, c);
                            room.player_alias = data.player_alias;
                            switchPanel("screen", "waitingRoom");
                            break;
                        case "invalid_room":
                            document.querySelector("#invalid_gid").innerText = "Invalid Room";
                            document.querySelector("#invalid_gid").style.display = "block";
                            document.querySelector("#invalid_gid").classList.remove("red_flashy");
                            setTimeout(() => {
                                document.querySelector("#invalid_gid").classList.add("red_flashy");
                            }, 100)
                            break;
                        case "too_many_players":
                            document.querySelector("#invalid_gid").innerText = "Room Full";
                            document.querySelector("#invalid_gid").style.display = "block";
                            document.querySelector("#invalid_gid").classList.remove("red_flashy");
                            setTimeout(() => {
                                document.querySelector("#invalid_gid").classList.add("red_flashy");
                            }, 100)
                            break;
                        case "game_begun":
                            document.querySelector("#invalid_gid").innerText = "The game has already started";
                            document.querySelector("#invalid_gid").style.display = "block";
                            document.querySelector("#invalid_gid").classList.remove("red_flashy");
                            setTimeout(() => {
                                document.querySelector("#invalid_gid").classList.add("red_flashy");
                            }, 100)
                            break;
                        case "new_player":
                            //add a new player
                            let d = document.createElement("div");
                            d.innerText = data.player_alias;
                            document.querySelector(".player-list").appendChild(d);
                            break;
                        case "start_game":
                            room.players = data.players;
                            renderTo(".inter-round-modal", `
                            <img src="logo2.png"></img>
                            <h3>Entering summit...</h3>
                            <p>Current round begins in <span class="inter-round-countdown">5</span></p>
                            `);
                            renderTo(".nation-name-p", room.player_alias)
                            document.querySelector(".inter-round-modal").style.display = "flex";
                            reset_reveals();
                            for (let i = 0; i < 4; i++) {
                                reveal_timers.push(setTimeout(() => renderTo(".inter-round-countdown", 4 - i), 1000 * (i + 1)));
                            }
                            reveal_timers.push(setTimeout(() => document.querySelector(".inter-round-modal").style.display = "none", 5000));
                            switchPanel("screen", "main");
                            switchPanel("pane", "action");
                            break;
                        case "begin_round":
                            renderTo(".current-round", `${data.current_round + 1} of ${data.total_rounds}`);
                            console.log(data);
                            room.current_set = data.current_set;
                            room.current_round = data.current_round;
                            room.total_rounds = data.total_rounds;
                            room.own_set = data.own_set;
                            room.private_resolutions = data.private_resolutions;
                            room.present_order = data.resolutions.map((i, ii) => ii);
                            renderTo(".current-mode", "Diplomacy mode");
                            renderTo(".instruction", "Prioritise bills " + data.private_resolutions.slice(0, 4).map((i, ii) => `${ii + 1}.${String.fromCharCode("A".charCodeAt(0) + i)}`).join(",") + "; failure = " + ((data.bill_penalty > 0) ? "+" + data.bill_penalty : data.bill_penalty));
                            let protoScore = room.present_order.reduce((p, i, ii) => p + (room.private_resolutions.indexOf(i) >= ii && room.private_resolutions.indexOf(i) < 4), 0);
                            document.querySelector(".proto-resolution-score-container").style.display = "block";
                            renderTo(".proto-resolution-score", protoScore);
                            //render bills in ABCD order
                            room.resolutions = data.resolutions;
                            renderTo(".proto-resolution-dragdrop", data.resolutions.map((i, ii) => `<p><span>${String.fromCharCode("A".charCodeAt(0) + ii)}</span><span>${i}</span></p>`).join(" "))
                            switchPanel("screen", "main");
                            switchPane("action");
                            room.player_aliases = data.player_aliases;
                            renderTo(".history-list", `
                                ${data.player_aliases.map((i, ii) =>
                                `
                                    <div class="proposalRow">
                                        <p>${i} (Current score: ${data.all_scores[ii]})</p>
                                        <div class="proposalBin">
                                            <p>Proposal pending...</p>
                                        </div>
                                        <p class="proposal_score">Proposal score pending...</p>
                                        <button disabled onclick="confirmBill(${ii})">Accept (0/${room.player_aliases.length} countries accepted)</button>
                                        <div class="acceptee">
                                            
                                        </div>
                                    </div>
                                    `).join("")}
                            `)
                            room.min_remaining = 5;
                            room.sec_remaining = 0;
                            renderTo(".remaining-time", `${room.min_remaining}:${room.sec_remaining > 10 ? "" : "0"}${room.sec_remaining}`);
                            clearInterval(room.remaining_ticker);// just in case
                            room.remaining_ticker = setInterval(() => {
                                room.sec_remaining--;
                                if (room.sec_remaining < 0) {
                                    room.sec_remaining = 59;
                                    room.min_remaining--;
                                }
                                document.querySelector(".remaining-time-bar").style.width = ((room.sec_remaining + room.min_remaining * 60) / 300 * 100) + "%"
                                renderTo(".remaining-time", `Time remaining: ${room.min_remaining}:${room.sec_remaining >= 10 ? "" : "0"}${room.sec_remaining}`);
                            }, 1000);
                            document.querySelector(".remaining-time-bar").style.width = "100%"
                            renderTo(".remaining-time", `Time remaining: 3:00`);
                            break;
                        case "bill_post":
                            //render the bill
                            let hibox = document.querySelector(`.history-list .proposalRow:nth-child(${data.proposing_country + 1})`);
                            hibox.querySelector(".proposalBin").innerHTML = `
                                ${data.bill.map((i => `<span>${String.fromCharCode("A".charCodeAt(0) + i)}</span>`)).join("")}
                            `;
                            let new_bill_score = data.bill.reduce((p, i, ii) => p + (room.private_resolutions.indexOf(i) >= ii && room.private_resolutions.indexOf(i) < 4), 0);
                            hibox.querySelector(".proposal_score").innerHTML = `Your score if this passes: ${new_bill_score}`;
                            if (room.player_aliases[data.proposing_country] != room.player_alias) {
                                hibox.querySelector("button").disabled = false; // cannot unaccept your own
                                hibox.querySelector("button").classList.remove("accepted_this");
                                hibox.querySelector("button").innerHTML = `Accept (1/${room.player_aliases.length} countries accepted)`;
                                hibox.querySelector("div.acceptee").innerHTML = `<p>Bill accepted by ${room.player_aliases[data.proposing_country]}</p>`;
                            }
                            else {
                                hibox.querySelector("button").classList.add("accepted_this");
                                hibox.querySelector("button").innerHTML = `Accepted (1/${room.player_aliases.length} countries accepted)`;
                                hibox.querySelector("div.acceptee").innerHTML = `<p>Bill accepted by ${room.player_alias}</p>`;
                            }

                            break;
                        case "bill_confirmed":
                            let accbox = document.querySelector(`.history-list  .proposalRow:nth-child(${data.bill_id + 1})`);
                            accbox.querySelector("button").innerHTML = `Accept${accbox.querySelector("button").classList.contains("accepted_this") ? "ed" : ""} (${Object.entries(data.bill_passees).length}/${room.player_aliases.length} countries accepted)`;
                            let accdiv = document.querySelector(`.history-list  .proposalRow:nth-child(${data.bill_id + 1}) div.acceptee`);
                            accdiv.innerHTML = Object.keys(data.bill_passees).map(i => `<p>Bill accepted by ${room.player_aliases[i]}</p>`).join("\n");
                            break;
                        case "bill_failed":
                            nextText = (room.total_rounds != room.current_round + 1) ? "Next round begins in" : "Final results in";

                            renderTo(".inter-round-modal", `
                            <h3>Result:</h3>
            <p class="roundresult">Bill passed / rejected</p>
            <div class="accepted-bill-container">

            </div>
            <p>Your current score: <span class="playerscore"></span></p>
            <p>${nextText} <span class="inter-round-countdown"></span></p>
                            `)
                            //say bill failed   
                            renderTo(".roundresult", "No bill passed :(")
                            clearTimeout(room.remaining_ticker);
                            //update score
                            document.querySelector(".accepted-bill-container").style.display = "none";
                            renderTo(".playerscore", `${data.score}`);

                            renderTo(".inter-round-countdown", 5);
                            reset_reveals();
                            for (let i = 0; i < 4; i++) {
                                reveal_timers.push(setTimeout(() => renderTo(".inter-round-countdown", 4 - i), 1000 * (i + 1)));
                            }
                            reveal_timers.push(setTimeout(() => document.querySelector(".inter-round-modal").style.display = "none", 5000));
                            //show splash, start timer
                            document.querySelector(".inter-round-modal").style.display = "flex";
                            break;
                        case "bill_passed":
                            nextText = (room.total_rounds != room.current_round + 1) ? "Next round begins in" : "Final results in";
                            renderTo(".inter-round-modal", `
                            <h3>Result:</h3>
            <p class="roundresult">Bill passed / rejected</p>
            <div class="accepted-bill-container">

            </div>
            <p>Your current score: <span class="playerscore"></span></p>
            <p>${nextText} <span class="inter-round-countdown"></span></p>
                            `)
                            document.querySelector(".inter-round-modal").style.display = "flex";
                            renderTo(".roundresult", "Bill Passed!");
                            document.querySelector(".accepted-bill-container").style.display = "block";
                            let win_bill_rows = data.bill.map((i, ii) => `<p>${String.fromCharCode("A".charCodeAt(0) + i)}:${room.resolutions[i]}</p>`).join(" ");
                            renderTo(".accepted-bill-container", win_bill_rows);
                            clearTimeout(room.remaining_ticker);

                            renderTo(".inter-round-countdown", 5);
                            reset_reveals();
                            for (let i = 0; i < 4; i++) {
                                reveal_timers.push(setTimeout(() => renderTo(".inter-round-countdown", 4 - i), 1000 * (i + 1)));
                            }
                            reveal_timers.push(setTimeout(() => document.querySelector(".inter-round-modal").style.display = "none", 5000));

                            renderTo(".playerscore", `${data.score}`);
                            document.querySelector(".inter-round-modal").style.display = "flex";
                            break;
                        case "player_disconnected":
                            nextText = (room.total_rounds != room.current_round + 1) ? "Next round begins in" : "Final results in";
                            renderTo(".inter-round-modal", `
                            <h3>A fellow diplomat has been disconnected</h3>
                            <p>Please hold while we re-establish order.</p>
                            <p>The United Nations appreciates your patience.</p>
                            <img src="logo2.png"></img>
                            <p>${nextText} <span class="inter-round-countdown"></span></p>
                            `)
                            renderTo(".inter-round-countdown", 5);
                            reset_reveals();
                            for (let i = 0; i < 4; i++) {
                                reveal_timers.push(setTimeout(() => renderTo(".inter-round-countdown", 4 - i), 1000 * (i + 1)));
                            }
                            reveal_timers.push(setTimeout(() => document.querySelector(".inter-round-modal").style.display = "none", 5000));
                            document.querySelector(".inter-round-modal").style.display = "flex";

                            break;
                        case "podium":
                            let winners = data.player_scores.map((i, ii) => [room.players[ii], i]).sort((a, b) => b[1] - a[1]);
                            renderTo(".podium", `
                        <h3>Congratulations to<h3>
                        <h2>The representative for ${winners[0][0]}<h2>
                            <canvas></canvas>
                            <h4>For their outstanding diplomatic service to their country!</h4>
                            <h3>Final Ranking</h3>
                            <div>
                                ${
                                winners.map(i => `<p>${i[0]}:${i[1]}</p>`).join("")
                                }
                            </div>
                            <h3> The UN summit 2021 has concluded. Thank you for your participation.</h3>
                            <p>Reload this window to start a new game.</p>
                            `)

                            nc = document.querySelector(".podium canvas");
                            makeFlag(winners[0][0], nc);
                            switchPanel("screen", "podium")
                            break;
                    }
                });
                ws.addEventListener("close", () => {
                    reset_reveals();
                    switchPanel("screen", "main");
                    renderTo(".inter-round-modal", `
                            <h3>Connection lost</h3>
                            <p>Re-connection functionality has not been implemented yet.</p>
                            <p>Please re-establish contact with the game host as soon as possible.</p>
                            <img src="logo2.png"></img>
                            `)
                    document.querySelector(".inter-round-modal").style.display = "flex";
                })
            } catch (e) {
                console.log("oh no");
            }
        }

        function submitForApproval() {
            if (ws) {
                if (room.current_set == room.own_set) {
                    ws.send(JSON.stringify({
                        action: "submit_bill",
                        bill: room.present_order
                    }))
                    switchPane("history")
                } else {
                    ws.send(JSON.stringify({
                        action: "submit_ranking",
                        bill: room.present_order
                    }))
                    renderTo(".submitbill", "Submission received");
                    setTimeout(() => renderTo(".submitbill", "Submit ranking"), 1500);
                }
            }
        }
        function confirmBill(i) {
            if (ws) {
                let thebutton = document.querySelector(`.history-list .proposalRow:nth-child(${i + 1}) button`);
                if (thebutton.classList.contains("accepted_this")) {
                    thebutton.classList.remove("accepted_this");
                    thebutton.innerText = thebutton.innerText.replace("Accepted", "Accept");
                    ws.send(JSON.stringify({
                        action: "unconfirm_bill",
                        bill_id: i
                    }))
                } else {
                    thebutton.innerText = thebutton.innerText.replace("Accept", "Accepted");
                    thebutton.classList.add("accepted_this");
                    ws.send(JSON.stringify({
                        action: "confirm_bill",
                        bill_id: i
                    }))
                }
            }
        }
        function tryHostGame() {
            try {
                if (ws) ws.close();
                ws = new WebSocket("ws://" + window.location.hostname + ":3320");
                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        action: "host_game",
                    }));
                }
                ws.addEventListener("message", (data) => {
                    data = JSON.parse(data.data);
                    switch (data.state) {
                        case "created_room":
                            // take them to the waiting room
                            renderTo("#gid_rep", data.uid);
                            renderTo(".player-head", "Players:");
                            renderTo(".nation-name", "<p>You are the game host. (If you would like to play, please open a new window.)</p> <img src='logo2.png'>");
                            document.querySelector(".wstart").innerText = "At least 3 players required";
                            document.querySelector(".wstart").disabled = true;
                            switchPanel("screen", "waitingRoom");
                            break;
                        case "waiting_room":
                            //add a new player
                            document.querySelectorAll(".player-list div").forEach(i => i.remove());
                            for (let i of data.players) {
                                let d = document.createElement("div");
                                d.innerText = i;
                                document.querySelector(".player-list").appendChild(d);
                            }
                            if (data.players.length > 2) {
                                document.querySelector(".wstart").innerText = "Start game";
                                document.querySelector(".wstart").disabled = false;
                            } else {
                                document.querySelector(".wstart").innerText = "At least 3 players required";
                                document.querySelector(".wstart").disabled = true;
                            }
                            break;
                        case "start_game":
                            console.log("got start");
                            Array.from(document.querySelectorAll(".player-list div")).forEach((i) => i.innerHTML = `${i.innerHTML}<button>Eject player</button>`);
                            document.querySelector(".wstart").style.display = "none";
                            break;
                        case "player_disconnected":
                            let player_kick_button = Array.from(document.querySelectorAll(".player-list div"))[data.player].querySelector("button");
                            player_kick_button.innerHTML = "DISCONNECTED";
                            player_kick_button.disabled = true;
                            break;
                        case "podium":
                            renderTo(".inter-round-modal", `
                            <img src="logo2.png"></img>
                            <h3>The game has concluded.</h3>
                            <p>Thanks for playing!</p>
                            <p>Reload this window to start a new game</p>
                            `);
                            document.querySelector(".inter-round-modal").style.display = "flex";
                            document.body.appendChild(document.querySelector(".inter-round-modal"));
                            break;
                    }
                })
            } catch (e) {
                console.log("oh no");
                //rip
            }
        }
        document.querySelector(".player-list").addEventListener("click", (e) => {
            if (e.target.matches("button")) {
                console.log("yeet");
                //kick the player
                let player_index = Array.from(document.querySelectorAll(".player-list button")).indexOf(e.target);
                ws.send(JSON.stringify({
                    action: "kick_player",
                    player: player_index
                }))
            }
        })
        function hostStart() {
            ws.send(JSON.stringify({
                action: "start_game"
            }))
        }
    </script>
</body>

</html>